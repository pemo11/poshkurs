name: Publish PoshKurs module to MyGet

on:
  push:
    tags:
      - 'v*'              # läuft bei Tags wie v1.2.0, v1.2.1, ...
  workflow_dispatch:       # manueller Start möglich

jobs:
  publish:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PowerShellGet if needed
        shell: pwsh
        run: |
          if (-not (Get-Module -ListAvailable -Name PowerShellGet)) {
            Install-Module PowerShellGet -Scope CurrentUser -Force -SkipPublisherCheck
          }

      - name: Install Pester 5.7.0
        shell: pwsh
        run: |
          Write-Host "Entferne vorinstalliertes Pester 3.x aus dem Systempfad..."
          $systemPester = "C:\Program Files\WindowsPowerShell\Modules\Pester"
          if (Test-Path $systemPester) {
            Rename-Item -Path $systemPester -NewName "Pester_3_DISABLED" -Force
          }

          Write-Host "Installiere Pester 5.7.0..."
          Install-Module Pester -RequiredVersion 5.7.0 -Scope CurrentUser -Force -SkipPublisherCheck

          Write-Host "Importiere Pester 5.7.0..."
          Import-Module Pester -RequiredVersion 5.7.0 -Force

          Write-Host "Verwendete Pester-Version:"
          (Get-Module Pester).Version

      - name: Determine module path (latest version folder under repo root)
        id: moduledir
        shell: pwsh
        run: |
          # Repo-Root ist bereits D:\a\poshkurs\poshkurs
          $root = $PWD

          Write-Host "Repo root is: $root"

          # Unterordner mit Versionsnamen wie 1.2.0, 1.3.0, 2.0.0 usw. suchen
          $versionFolders = Get-ChildItem $root -Directory |
            Where-Object { $_.Name -match '^\d+\.\d+\.\d+(-.*)?$' } |
            Sort-Object Name -Descending

          if ($versionFolders.Count -eq 0) {
            Write-Error "Kein Versionsordner unter '$root' gefunden. Erwartet z.B. '1.2.0'."
          }

          $modulePath = $versionFolders[0].FullName
          Write-Host "Using module path: $modulePath"

          "modulePath=$modulePath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Run Pester tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "Running Pester tests from ./tests"
          Invoke-Pester -Path ./tests -Output Detailed -CI

      - name: Register MyGet repository (poshrepo)
        shell: pwsh
        run: |
          $repoName        = 'PemoMyGet'
          $sourceLocation  = 'https://www.myget.org/F/poshrepo/api/v2'
          $publishLocation = 'https://www.myget.org/F/poshrepo/api/v2/package'

          if (-not (Get-PSRepository -Name $repoName -ErrorAction SilentlyContinue)) {
            Register-PSRepository -Name $repoName `
              -SourceLocation  $sourceLocation `
              -PublishLocation $publishLocation `
              -InstallationPolicy Trusted
          } else {
            Write-Host "Repository $repoName already registered."
          }

      - name: Set module version from tag (optional, aber praktisch)
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $tag = "${{ github.ref }}" -replace 'refs/tags/', ''
          $version = $tag.TrimStart('v')

          $modulePath = '${{ steps.moduledir.outputs.modulePath }}'
          $psd1 = Get-ChildItem -Path $modulePath -Filter *.psd1 | Select-Object -First 1
          if (-not $psd1) {
            Write-Error "Keine .psd1 im Ordner $modulePath gefunden."
          }

          (Get-Content $psd1.FullName) `
            -replace "ModuleVersion\s*=\s*'[^']+'", "ModuleVersion = '$version'" `
            | Set-Content $psd1.FullName -Encoding UTF8

          Write-Host "Set ModuleVersion in $($psd1.Name) to $version"

      - name: Show module manifest info
        shell: pwsh
        run: |
          $modulePath = '${{ steps.moduledir.outputs.modulePath }}'
          $psd1 = Get-ChildItem -Path $modulePath -Filter *.psd1 | Select-Object -First 1
          if (-not $psd1) {
            Write-Error "Keine .psd1 im Ordner $modulePath gefunden."
          }
          $manifest = Test-ModuleManifest -Path $psd1.FullName
          Write-Host "Found module: $($manifest.Name) Version: $($manifest.Version)"
          Write-Host "Module base:  $($manifest.ModuleBase)"

      - name: Publish module to MyGet (poshrepo)
        shell: pwsh
        env:
          NUGET_API_KEY: ${{ secrets.MYGET_API_KEY }}
        run: |
          $modulePath = '${{ steps.moduledir.outputs.modulePath }}'
          $psd1 = Get-ChildItem -Path $modulePath -Filter *.psd1 | Select-Object -First 1
          $manifest = Test-ModuleManifest -Path $psd1.FullName
          $moduleName = $manifest.Name

          if (-not $env:NUGET_API_KEY) {
            Write-Error "NUGET_API_KEY environment variable not set. Bitte GitHub Secret MYGET_API_KEY prüfen."
          }

          Write-Host "Publishing module $moduleName from $modulePath to MyGet repo 'PemoMyGet'..."
          Publish-Module -Path $modulePath `
                         -Repository 'PemoMyGet' `
                         -NuGetApiKey $env:NUGET_API_KEY `
                         -Verbose

      - name: Smoke test - install PoshKurs from MyGet
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # Repository sicherheitshalber nochmal registrieren
          if (-not (Get-PSRepository -Name 'PemoMyGet' -ErrorAction SilentlyContinue)) {
            Register-PSRepository -Name 'PemoMyGet' `
              -SourceLocation  'https://www.myget.org/F/poshrepo/api/v2' `
              -InstallationPolicy Trusted
          }

          Write-Host "Installing PoshKurs from MyGet (PemoMyGet)..."
          Install-Module -Name PoshKurs -Repository 'PemoMyGet' -Scope CurrentUser -Force -AllowClobber

          Write-Host "Importing PoshKurs..."
          Import-Module PoshKurs -ErrorAction Stop

          Write-Host "Smoke test OK: PoshKurs could be installed and imported from MyGet."
